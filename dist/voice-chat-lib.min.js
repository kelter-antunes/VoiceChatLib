var VoiceChatLib=(()=>{var e;function c(t,e){return t?"string"==typeof t?document.querySelector(t):t:document.querySelector(e)}function i(t){if(this.config={amplitudeSmoothFactorVar:.3,baseRotationDivisor:16,dynamicLerpMin:.05,dynamicLerpAudioMultiplier:.5,maxAdditionalRotation:360,baseScaleMultiplier:2,elements:{toggleBtn:"#toggleMicBtn",endBtn:"#endChatBtn",voiceEls:".a-cue-voice-el"}},t)for(var e in t)if(t.hasOwnProperty(e))if("elements"===e)for(var i in t.elements)t.elements.hasOwnProperty(i)&&(this.config.elements[i]=t.elements[i]);else this.config[e]=t[e];this.audioStream=null,this.audioContext=null,this.analyser=null,this.microphone=null,this.animationId=null,this.isMicOn=!0,this.smoothedAmplitude=0,this.startTime=null,this.lastFrameTime=null,this.MAX_DELTA=100,this.voiceEls=[],this.toggleBtn=null,this.endBtn=null,this.elementsBound=!1,this.audioStarted=!1,this.domObserver=null,this.mediaRecorder=null,this.recordedChunks=[],this.onStart=null,this.onToggle=null,this.onEnd=null,this.toggleBtnBound=!1,this.endBtnBound=!1;var o=this;this.handleToggle=function(t){t.preventDefault(),o.toggleMic()},this.handleEnd=function(t){t.preventDefault(),o.end()}}return i.prototype.setOptions=function(t){for(var e in t)if(t.hasOwnProperty(e))if("elements"===e)for(var i in t.elements)t.elements.hasOwnProperty(i)&&(this.config.elements[i]=t.elements[i]);else this.config[e]=t[e]},i.prototype.initElements=function(){for(var t,e=this.config.elements,i=(this.toggleBtn=c(e.toggleBtn,"#toggleMicBtn"),this.endBtn=c(e.endBtn,"#endChatBtn"),this.voiceEls=(t=".a-cue-voice-el",(e=e.voiceEls)?"string"==typeof e?document.querySelectorAll(e):e:document.querySelectorAll(t)),performance.now()),o=0;o<this.voiceEls.length;o++){var n,a,s,r,d,l=this.voiceEls[o];l.initialized||(r=(360*Math.random()).toFixed(0),n=(1+2*Math.random()).toFixed(2),a=(1+1.5*Math.random()).toFixed(2),l.dataset.offset=r,l.dataset.speed=n,l.dataset.scaleMultiplier=a,d=(45+10*Math.random()).toFixed(0),s=(45+10*Math.random()).toFixed(0),l.style.transformOrigin=d+"% "+s+"%",this.audioStarted&&"number"==typeof this.startTime?(d=i-this.startTime,s=parseFloat(r)+d*parseFloat(n)/this.config.baseRotationDivisor,r=this.smoothedAmplitude*this.config.maxAdditionalRotation,l.currentRotation=s+r,d=1+this.smoothedAmplitude*parseFloat(a)*this.config.baseScaleMultiplier,l.currentScale=d):(l.currentRotation=0,l.currentScale=1),l.initialized=!0)}this.toggleBtn&&!this.toggleBtnBound&&(this.toggleBtn.addEventListener("click",this.handleToggle),this.toggleBtnBound=!0),this.endBtn&&!this.endBtnBound&&(this.endBtn.addEventListener("click",this.handleEnd),this.endBtnBound=!0),this.updateMicDisplay(),this.elementsBound=!0},i.prototype.observeDOM=function(){var e=this;this.domObserver||(this.domObserver=new MutationObserver(function(t){e.initElements()}),this.domObserver.observe(document.body,{childList:!0,subtree:!0}))},i.prototype.updateMicDisplay=function(){this.toggleBtn&&(this.toggleBtn.classList.toggle("is--on",this.isMicOn),this.toggleBtn.classList.toggle("is--off",!this.isMicOn))},i.prototype.lerp=function(t,e,i){return t+i*(e-t)},i.prototype.initAudio=function(){var e=this;navigator.mediaDevices.getUserMedia({audio:!0}).then(function(t){e.audioStream=t,e.audioContext=new(window.AudioContext||window.webkitAudioContext),e.microphone=e.audioContext.createMediaStreamSource(t),e.analyser=e.audioContext.createAnalyser(),e.analyser.fftSize=256,e.microphone.connect(e.analyser);t=e.audioStream.getAudioTracks()[0],t=t&&t.label?t.label:"(unknown)";if(e.updateMicDisplay(),e.startTime=performance.now(),e.lastFrameTime=e.startTime,e.updateAnimation(),e.audioStarted=!0,window.MediaRecorder){e.recordedChunks=[];try{e.mediaRecorder=new MediaRecorder(e.audioStream),e.mediaRecorder.ondataavailable=function(t){t.data&&0<t.data.size&&e.recordedChunks.push(t.data)},e.mediaRecorder.start()}catch(t){console.error("MediaRecorder creation failed:",t)}}else console.warn("MediaRecorder API not supported in this browser.");"function"==typeof e.onStart&&e.onStart({event:"start",timestamp:Date.now(),details:"VoiceChat audio and recording successfully started",isMicOn:e.isMicOn,microphoneLabel:t})}).catch(function(t){console.error("Error accessing the microphone:",t),alert("Could not access the microphone. Check your permissions.")})},i.prototype.updateAnimation=function(){var n=this;if(n.analyser){var t=performance.now();n.lastFrameTime||(n.lastFrameTime=t,n.startTime=t);t-n.lastFrameTime>n.MAX_DELTA&&(n.startTime=t),n.lastFrameTime=t;for(var e=new Uint8Array(n.analyser.frequencyBinCount),i=(n.analyser.getByteTimeDomainData(e),0),o=0;o<e.length;o++)i+=Math.abs(e[o]-128);var a=i/e.length,s=(n.smoothedAmplitude=n.smoothedAmplitude*(1-n.config.amplitudeSmoothFactorVar)+a/128*n.config.amplitudeSmoothFactorVar,t-n.startTime),r=n.config.dynamicLerpMin+n.smoothedAmplitude*n.config.dynamicLerpAudioMultiplier;n.voiceEls.forEach(function(t){var e=parseFloat(t.dataset.offset),i=parseFloat(t.dataset.speed),o=parseFloat(t.dataset.scaleMultiplier),e=e+s*i/n.config.baseRotationDivisor,i=n.smoothedAmplitude*n.config.maxAdditionalRotation,o=1+n.smoothedAmplitude*o*n.config.baseScaleMultiplier;t.currentRotation=n.lerp(t.currentRotation,e+i,r),t.currentScale=n.lerp(t.currentScale,o,r),t.style.transform="rotate("+t.currentRotation.toFixed(2)+"deg) scale("+t.currentScale.toFixed(2)+")"}),n.animationId=requestAnimationFrame(function(){n.updateAnimation()})}},i.prototype.toggleMic=function(){var e=this;this.mediaRecorder?this.isMicOn?("recording"===this.mediaRecorder.state&&this.mediaRecorder.pause(),this.isMicOn=!1,this.audioStream&&this.audioStream.getAudioTracks().forEach(function(t){t.enabled=!1})):("paused"===this.mediaRecorder.state&&this.mediaRecorder.resume(),this.isMicOn=!0,this.audioStream&&this.audioStream.getAudioTracks().forEach(function(t){t.enabled=!0})):this.audioStream&&0<this.audioStream.getAudioTracks().length&&(this.isMicOn=!this.isMicOn,this.audioStream.getAudioTracks().forEach(function(t){t.enabled=e.isMicOn})),this.updateMicDisplay(),"function"==typeof e.onToggle&&e.onToggle({event:"toggleMic",timestamp:Date.now(),isMicOn:e.isMicOn,details:"Microphone toggled"})},i.prototype.end=function(){var a=this;this.animationId&&cancelAnimationFrame(this.animationId),this.audioStream&&this.audioStream.getTracks().forEach(function(t){t.stop()}),this.audioContext&&this.audioContext.close(),this.toggleBtn&&(this.toggleBtn.disabled=!0),this.endBtn&&(this.endBtn.disabled=!0),!this.mediaRecorder||"recording"!==this.mediaRecorder.state&&"paused"!==this.mediaRecorder.state?"function"==typeof a.onEnd&&a.onEnd({event:"end",timestamp:Date.now(),details:"VoiceChat session ended (no audio recorded)"}):(this.mediaRecorder.onstop=function(t){var i=new Blob(a.recordedChunks,{type:"audio/webm"}),e=performance.now()-a.startTime,o="voice-chat-"+Math.random().toString(36).substring(2,10)+".webm";var n={duration:e,durationReadable:(e=e,e=Math.floor(e/1e3),Math.floor(e/60)+" min "+e%60+" sec"),size:i.size,sizeReadable:(e=i.size)<1024?e+" Bytes":e<1048576?(e/1024).toFixed(1)+" KB":e<1073741824?(e/1048576).toFixed(1)+" MB":(e/1073741824).toFixed(1)+" GB",mimeType:i.type},e=new FileReader;e.onload=function(t){var e=t.target.result,t=new FileReader;t.onload=function(t){t=t.target.result;"function"==typeof a.onEnd&&a.onEnd({event:"end",timestamp:Date.now(),details:"VoiceChat session ended",audioBlob:i,audioMeta:n,audioBinary:e,audioBase64:t,fileName:o})},t.readAsDataURL(i)},e.readAsArrayBuffer(i)},this.mediaRecorder.stop())},i.prototype.reset=function(){if(this.animationId&&(cancelAnimationFrame(this.animationId),this.animationId=null),this.audioStream&&(this.audioStream.getTracks().forEach(function(t){t.stop()}),this.audioStream=null),this.audioContext&&("closed"!==this.audioContext.state&&this.audioContext.close().catch(function(t){console.warn("AudioContext close failed (it may be already closed):",t)}),this.audioContext=null),this.mediaRecorder&&"inactive"!==this.mediaRecorder.state){try{this.mediaRecorder.stop()}catch(t){console.error("Error stopping media recorder during reset:",t)}this.mediaRecorder=null}this.recordedChunks=[],this.startTime=null,this.lastFrameTime=null,this.audioStarted=!1,this.isMicOn=!0,this.toggleBtn&&(this.toggleBtn.disabled=!1),this.endBtn&&(this.endBtn.disabled=!1),this.toggleBtn&&this.toggleBtnBound&&(this.toggleBtn.removeEventListener("click",this.handleToggle),this.toggleBtnBound=!1),this.endBtn&&this.endBtnBound&&(this.endBtn.removeEventListener("click",this.handleEnd),this.endBtnBound=!1),this.toggleBtn=null,this.endBtn=null,this.voiceEls=[],this.elementsBound=!1},i.prototype.start=function(){this.observeDOM(),this.initElements(),this.audioStarted||this.initAudio()},{getInstance:function(t){return e?t&&e.setOptions(t):e=new i(t||{}),e}}})();